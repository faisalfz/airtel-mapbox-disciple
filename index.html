<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map with Search</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
      }

      #map {
        height: 90%;
        width: 100%;
      }

      #controls {
        height: 10%;
        padding: 10px;
        background: #f8f8f8;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      .leaflet-popup-content-wrapper {
        max-height: 200px;
        overflow-y: auto;
      }

      article.location-detail {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .location-detail h3,
      .location-detail p {
        margin: 0;
        padding: 0;
      }

      .location-detail h3 {
        font-size: 14px;
        line-height: 16px;
        font-weight: 700;
      }

      .location-detail p {
        font-size: 12px;
        font-weight: 100;
        color: rgb(82, 81, 81);
      }

      .location-detail .show-more {
        color: blue;
        cursor: pointer;
      }

      .location-detail .full-description {
        display: none;
      }

      #searchBox {
        padding: 5px;
        width: 200px;
      }

      #locationDropdown {
        padding: 5px;
        width: 200px;
      }
    </style>
  </head>
  <body>
    <!-- Controls for Search and Dropdown -->
    <div id="controls">
      <input
        type="text"
        id="searchBox"
        placeholder="Search location by name"
      />
      <select id="locationDropdown">
        <option value="">Select a location</option>
      </select>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      // Initialize Leaflet map
      var map = L.map("map").setView([34.0522, -118.2437], 10); // Set default view to Los Angeles

      // Add base map layer using Mapbox Streets style
      L.tileLayer(
        "https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoic2FhZGZpYXoiLCJhIjoiY2x4NTl1ajQ5MDd2ZjJsczVwZjJxdjg5ZyJ9.qRpkurVrJGU2WHtezx3-NQ",
        {
          attribution:
            '&copy; <a href="https://www.mapbox.com/about/maps/">Mapbox</a> contributors',
          tileSize: 512,
          zoomOffset: -1,
        }
      ).addTo(map);

      var markers = [];
      var locations = [];

      // Create custom marker icon (optional)
      var customIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png", // Change to your custom icon
        iconSize: [25, 41], // size of the icon
        iconAnchor: [12, 41], // point of the icon which will correspond to marker's location
        popupAnchor: [1, -34], // point from which the popup should open relative to the iconAnchor
      });

      // Function to create location details HTML
      function createLocationDetails(location) {
        let details = `<article class="location-detail">
                <h3>${location.name}</h3>`;

        if (location.website) {
          details += `<p><strong>Website:</strong> <a href="${location.website}" target="_blank">${location.website}</a></p>`;
        }
        if (location.phone) {
          details += `<p><strong>Phone:</strong> ${location.phone}</p>`;
        }
        if (location.email) {
          details += `<p><strong>Email:</strong> <a href="mailto:${location.email}">${location.email}</a></p>`;
        }
        if (location.hours_of_Operation) {
          details += `<p><strong>Hours:</strong> ${location.hours_of_Operation}</p>`;
        }
        if (location.description) {
          details += `<p class="description">${location.description.substring(
            0,
            100
          )}<span class="show-more"> Show more</span></p>
                            <p class="full-description">${
                              location.description
                            }</p>`;
        }

        details += `</article>`;
        return details;
      }

      // Fetch JSON data from locations.json
      fetch("locations-4.json")
        .then((response) => response.json())
        .then((data) => {
          locations = data;

          // Add markers from JSON data and populate the dropdown
          locations.forEach((location, index) => {
            var marker = L.marker(
              [location.latitude, location.longitude],
              // { icon: customIcon }
            ).addTo(map);
            marker.bindPopup(createLocationDetails(location));

            // Store the marker in the markers array
            markers.push(marker);

            // Add location to the dropdown
            var option = document.createElement("option");
            option.value = index;
            option.text = location.name;
            document.getElementById("locationDropdown").appendChild(option);

            // Event listener for show more in popups
            marker.on("popupopen", function () {
              document.querySelectorAll(".show-more").forEach((element) => {
                element.addEventListener("click", function () {
                  var parent = this.closest(".location-detail");
                  parent.querySelector(".description").style.display = "none";
                  parent.querySelector(".full-description").style.display =
                    "block";
                });
              });
            });
          });
        })
        .catch((error) => {
          console.error("Error fetching data:", error);
        });

      // Search box functionality
      document.getElementById("searchBox").addEventListener("input", (e) => {
        const searchValue = e.target.value.toLowerCase();
        const locationIndex = locations.findIndex((location) =>
          location.name.toLowerCase().includes(searchValue)
        );

        if (locationIndex !== -1) {
          map.setView(
            [locations[locationIndex].latitude, locations[locationIndex].longitude],
            13
          );
          markers[locationIndex].openPopup();
        }
      });

      // Dropdown functionality
      document
        .getElementById("locationDropdown")
        .addEventListener("change", (e) => {
          const selectedIndex = e.target.value;

          if (selectedIndex !== "") {
            const selectedLocation = locations[selectedIndex];
            map.setView([selectedLocation.latitude, selectedLocation.longitude], 13);
            markers[selectedIndex].openPopup();
          }
        });
    </script>
  </body>
</html>
